\chapter{Locally Orderless Images}\label{chapter:LOI}
\lhead{\cref{chapter:LOI} \emph{Locally Orderless Images}} % This is for the header on each page - perhaps a shortened title
\section{Histogram of an image}\label{HistIm}
Consider an image $I:\Omega \to \Gamma$, where $\Omega\subset \R^k$ denotes the image domain. The histogram of the image can be estimated as follows. Let $J = \{j_i\}_i^n$ denote a set of bins over the intensity values such that $j_1< j_2<\dots < j_n$, where $j_n=\max\{I(\vec{x})\:|\: \vec{x}\in\Omega\}$ and $j_1 = \min\{I(\vec{x})\:|\: \vec{x}\in\Omega\}$. Hence the bin-widths are $\Delta j_m=j_{m+1}-j_m>0$ for $1\leq m\leq n$. We can now introduce an indicator function, equivalent to a constant B-spline (definition \ref{Bspline}), by
\begin{equation}
  B_m^0(i):= 
  \begin{cases}
    1, & \mbox{ if }  i\in [j_m,j_{m+1})\\
    0, & \mbox{ else}
  \end{cases},\quad 1\leq m\leq n-1
\end{equation}

such that the histogram $h(m)$ is given by
\begin{align}
  h(m) &= \int_\Omega B_m^0(I(\vec{x})) \df \vec{x}.\label{hist0}
\intertext{For continuous images, we consider the area in $\Omega$, when $I(\vec{x})\in [j_m,j_{m+1})$. For discrete image, \eqref{hist0} turns into the sum}
  h(m) &= \sum_{\vec{x}\in\Omega} B_m^0I(\vec{x})
\end{align}
which exactly counts the number of intensity values in a certain bin. This resembles our understanding of a ``conventional'' histogram, where the size of $\Delta i_m$ controls the detail in the histogram. 

\section{Locally Orderless Images}
\begin{figure}
  \centering
  \subfigure[\label{subfig:randim}]{\includegraphics[width=0.4\textwidth]{RandIm.eps}}
  \quad
  \subfigure[\label{subfig:histrandim}]{\includegraphics[width=0.4\textwidth]{HistRandIm.eps}}
  \caption{\ref{subfig:randim} Image with noise and \ref{subfig:histrandim} corresponding histograms. The conventional histogram is generated according to the formulation \eqref{hist0}. The smoothened histogram is generated by extracting soft isocurves using the Parzen window stated in \eqref{loikernel}. Thus this corresponds to letting $\alpha\to\infty, \sigma\to 0$.}\label{fig:HistRandIm}
\end{figure}

The representation of Locally Orderless Images was introduced in \cite{koe.99}. The idea is to represent an image by a histogram of the intensities in the image. Allthough one disregards the spatial structure of the image, the tonal structure of the image is preserved. Thus representing an image by its histogram results in a simple, efficient and flexible description of the structure in the image. Moreover, we are not only interested in the global structure of an image, but also in local structures that appear in parts of the image, so called regions of interest. For example on an image containing the sky and a beach, we might be interested in considering the sky and the beach separately. Thus the notion of local histograms was introduced.\\

Taking those considerations into account, an image $I$ is smoothened using a kernel $G$. Then smooth isocurves of the image are extracted from the smoothed image with a kernel $P$.\\
The regions of interest are handled using a window kernel $W$, calculating the mass of the smooth isocurve in a neighborhood of a given point $\vec{x}_0$. This yields the following notion of the histogram:
\begin{equation}
  h_I(i,\vec{x}_0,\alpha,\beta,\sigma) = P((I(\vec{x})*G(\vec{x},\sigma))-i,\beta)*W(\vec{x};\vec{x}_0,\alpha),
\end{equation}

where $G:\R^k\times (0,\infty)\to (0,\infty)$ and $W:\R^k\times \R^k\times (0,\infty)\to (0,\infty)$ are spatial measurement kernels of scales $\sigma$ and $\alpha$ respectively. The image's spatial variation wrt. $\vec{x}$ is discarded on the $\sigma$-scale and $P:\R\times(0,\infty)\to [0,1]$ is the intensity measurement kernel of scale $\beta$. In \cite{koe.99} they are given by
\begin{equation}
  \begin{split}
    G(\vec{x},\sigma) &= \frac{\exp(-\vec{x}^T\vec{x}/(2\sigma^2))}{(\sqrt{2\pi}\sigma)^{k}},\quad W(\vec{x};\vec{x}_0,\alpha) = \frac{\exp(-(\vec{x}-\vec{x}_0)^T(\vec{x}-\vec{x}_0)/(2\alpha^2))}{(\sqrt{2\pi}\alpha)^{k}},\\
    P(d,\beta) &= \exp(-d^2/(2\beta^2)).
  \end{split}\label{loikernel}
\end{equation}

\begin{figure}
  \centering
  \subfigure[\label{subfig:iso1}]{\includegraphics[width=0.4\textwidth]{SoftIso1.eps}}
  \quad
  \subfigure[\label{subfig:iso2}]{\includegraphics[width=0.4\textwidth]{SoftIso2.eps}}
  \caption{Two soft isocurves extracted from the smoothened image using the Parzen window defined in \eqref{loikernel}.}\label{fig:SoftIso}
\end{figure}
\begin{definition}[Parzen Estimate]\label{parzen}
Let $P:\R\to \R$ be a function such that $\int_\R P(x) \df x= 1$ and let $\{x_i\}_{i=1}^N$ be a set of $n$ samples of a random variable $X$ with probability density function $p(x)$. $P$ is called a Parzen window and the Parzen estimate of $p$ is 
\begin{equation}
\tilde{p}_N(x) = \frac{1}{n\beta(N)}\sum_{i=1}^n P((x-x_i)/\beta(n)).
\end{equation}

It is required for $\beta(n)$ to be strictly positive and $\lim_{n\to\infty}\beta(n) = 0$ to ensure that the Parzen estimate convergence to the density $p$. $\beta$ acts as a scaling factor that controls the width of the Parzen window $P$. \cite{the.00,parzen.62}
\end{definition}

When normalizing $P$ in \eqref{loikernel}, we obtain a Parzen window with infinite support. Let $d=I(\vec{x})-i$, then the values close to $i$ will attain the maximum value of the Parzen window, but any $I(\vec{x})\in \R$ will contribute, since $P(d,\beta)>0$ for all $d\in\R$. To illustrate how the Parzen window works, two soft isocurves are extracted from the smoothed image in figure \ref{fig:SoftIso}. The values close to 1 (white) resemble the intensity values close to $i$.\\

Figure \ref{fig:HistRandIm} shows the conventional histogram generated as described in \sref{HistIm} and, for comparison, the histogram using the smooth kernel $P$ to extract the soft isocurves. This is the case when letting $\alpha\to \infty$, $\sigma\to 0$. In figure \ref{fig:HistSmoothRandIm}, the image is smoothed with the kernel $G$ before extracting the isocurves, i.e. only $\alpha\to\infty$ in $h_I$. Finally in figure \ref{fig:LocHistSmoothRandIm}, we see the local histogram around the point $\vec{x}_0 = (60,60)$. Here only the high intensity values appear in the histogram, since we have chosen a neighborhood of a point from the inner segment that contains the high intensity values.\\
Summarizing the effect of the kernels, we find that $P$ is used to extract soft isocurves of the intensity values, i.e. there are no jumps in the histogram. $G$ is used to smoothen the whole image, and $W$ is used to generate a local histogram around a point $x_0$.\\
One might notice that the smooth histogram attains lower values at the extrema of the intensities (0 and 1) in comparison to the conventional histogram. This is caused by the symmetry of the particular Parzen window in \eqref{loikernel}. Since 0 is the minimum there are only larger intensity values in the image, yielding a smaller response value in the histogram and correspondingly for 1, the maximum of the intensity values.\\
So in stead of viewing an image as pixels related to each other, in LOI we consider the image's isocurves - the intensity values close to a certain intensity value - to learn something about the image's structure.

\begin{figure}
  \centering
  \subfigure[\label{subfig:smoothim}]{\includegraphics[width=0.4\textwidth]{SmoothRandIm.eps}}
  \quad
  \subfigure[\label{subfig:histsmoothim}]{\includegraphics[width=0.4\textwidth]{HistSmoothRandIm.eps}}
  \caption{\ref{subfig:smoothim} Smoothed image and \ref{subfig:histsmoothim} corresponding histograms using the Gaussian kernel from \eqref{loikernel}.}\label{fig:HistSmoothRandIm}
\end{figure}

The Parzen estimate (definition \ref{parzen}) of the probability density can be obtained by normalizing \cite{dar.11}. Hence
\begin{equation}
\bar{p}_I(i,\vec{x}_0,\alpha,\beta,\sigma) = \frac{h_I(i,\vec{x}_0,\alpha,\beta,\sigma)}{\int_\Gamma h_I(k,\vec{x}_0,\alpha,\beta,\sigma)\df k}.
\end{equation}


\begin{figure}
  \centering
  \subfigure[\label{subfig:locsmoothim}]{\includegraphics[width=0.4\textwidth]{LocSmoothRandIm.eps}}
  \quad
  \subfigure[\label{subfig:lochistsmoothim}]{\includegraphics[width=0.4\textwidth]{LocHistSmoothRandIm.eps}}
  \caption{\ref{subfig:locsmoothim} Smoothed image showing $W$-kernel in red and \ref{subfig:lochistsmoothim} corresponding local histogram using the Gaussian kernel from \eqref{loikernel}.}\label{fig:LocHistSmoothRandIm}
\end{figure}

Thus from the histogram $h_I$, we can obtain an estimate of the probability density $\bar{p}_I$ on $I$ that varies wrt. $\vec{x}_0$ in local histograms, discarding the local spatial order.\\

\begin{definition}[Scale Space]\label{scalespace}
Given an image $I:\Omega\to \R$, the scale-space is the family of derived signals $L(\vec{x},\sigma)$ given by the convolution of a kernel $G$ and the image $I$, i.e.

\begin{equation}
L(\vec{x},\sigma) = G(\vec{x},\sigma)*I(\vec{x}) = \int_{\Omega} G(\vec{y},\sigma)I(\vec{x}-\vec{y})d\vec{y}
\end{equation}

where $\sigma$ denotes the scale parameter and $*$ is the convolution operator wrt. $\vec{x}$.
\end{definition}

Fixing $i,\sigma,\beta$, we obtain a scale space with the spatial variable $\vec{x}_0$ and scale parameter $\alpha$. Similarly, fixing $\vec{x}_0,\alpha,\sigma$ yields a scale space with $i$ as variable and scale parameter $\beta$. Furthermore the smoothed image $I(\vec{x})*G(\vec{x},\sigma)$ itself is a scale space \cite{dar.12}.\\

A popular choice of Parzen windows are B-splines \cite{the.00}, because they are smooth functions with finite support. Note that a B-spline itself is a Parzen window as shown in proposition \ref{PWBspline}. This means that the computation time of the histogram can be reduced significantly, because we are only considering points in the neighborhood in order to compute a certain value of $h$.\\
As mentioned, this formulation also resembles the conventional histogram of an image described in \sref{HistIm} by letting $\alpha\to\infty$, $\sigma\to 0$ and letting $P=B_m^0$ choosing the knots equidistant with $\Delta i_m = \beta$.