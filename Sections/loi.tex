 % For referencing the chapter elsewhere, use \ref{Chapter1} 

\lhead{\cref{chapter:LOI} \emph{Locally Orderless Images}} % This is for the header on each page - perhaps a shortened title
\chapter{Locally Orderless Images}\label{chapter:LOI}
\section{Histogram of an image}\label{HistIm}
Consider an image $I:\Omega \to \R$, where $\Omega\subset \R^k$ denotes the image domain. The histogram of the image can be estimated as follows. Let $I(\vec{x}) = \{i_j\}_{j=1}^n$, $n\in\N$ denote the set of isophotes (=knots) such that $i_1< i_2<\dots < i_n$, where $i_n=\max\{I(\vec{x})\:|\: \vec{x}\in\Omega\}$ and $i_1 = \min\{I(\vec{x})\:|\: \vec{x}\in\Omega\}$. Hence the bin-widths are $\Delta i_m=i_{m+1}-i_m>0$ for $1\leq m\leq n$. We can now introduce an indicator function, equivalent to a constant B-spline (definition \ref{Bspline}), by

\begin{equation}
  B_m^0(i):= 
  \begin{cases}
    1, & \mbox{ if }  i\in [i_m,i_{m+1})\\
    0, & \mbox{ else}
  \end{cases},\quad 1\leq m\leq n-1
\end{equation}

such that the histogram $h(m)$ is given by

\begin{align}
  h(m) &= \int_\Omega B_m^0(I(\vec{x})) \df \vec{x}.\label{hist0}
\intertext{Thus $h(m)$ measures the area in $\Omega$ when $I(\vec{x})$ lies in a certain bin. For discrete image, \eqref{hist0} turns into the sum}
  h(m) &= \sum_{\vec{x}\in\Omega} B_m^0I(\vec{x})
\end{align}

which exactly counts the number of points in a certain bin. This resembles our traditional understanding of a histogram, where the size of $\Delta i_m$ controls the detail in the histogram. For continuous images, we consider the area in $\Omega$, when $I(\vec{x}\in [i_m,i_{m+1})$.

\section{Locally Orderless Images}
\begin{figure}
  \centering
  \subfigure[\label{subfig:randim}]{\includegraphics[width=0.4\textwidth]{RandIm.eps}}
  \quad
  \subfigure[\label{subfig:histrandim}]{\includegraphics[width=0.4\textwidth]{HistRandIm.eps}}
  \caption{\ref{subfig:randim} Image with noise and \ref{subfig:histrandim} corresponding histograms. The ``conventional'' histogram is generated according to the formulation \eqref{hist0}. The smoothened histogram is generated by extracting soft isophotes using the Parzen window stated in \eqref{loikernel}. Thus this corresponds to letting $\alpha,\sigma\to\infty$.}\label{fig:HistRandIm}
\end{figure}

The representation of locally orderless images was introduced in \cite{koe.99}. The idea is to represent an image by a histogram of the intensities in the image. Allthough one disregards the spatial structure of the image, the tonal structure of the image is preserved. Thus representing an image by its histogram results in a simple, efficient and flexible description of the structure in the image. Furthermore, we are not only interested in the global structure of an image, but also in local structures that appear in parts of the image, socalled regions of interest. For example on an image containing the sky and a beach, we might be interested in considering the sky and the beach seperately. Thus the notion of local histograms was introduced.\\

Taking this into account, an image $I$ is smoothened using a kernel $G$. Then the isophotes of the image are extracted from the smoothed image with a kernel $P$.\\
The regions of interest are handled using a window kernel $W$, calculating the isophote mass in a neighborhood of a given point $\vec{x}_0$. This yields the following notion of the histogram:

\begin{equation}
  h_I(i,\vec{x}_0,\alpha,\beta,\sigma) = P((I(\vec{x})*G(\vec{x},\sigma))-i,\beta)*W(\vec{x}_0,\alpha),
\end{equation}

where $G:\R^k\times (0,\infty)\to (0,\infty)$ and $W:\R^k\times \R^k\times (0,\infty)\to (0,\infty)$ are a spatial measurement kernels of scales $\sigma$ and $\alpha$ respectively. The image's spatial variation wrt. $\vec{x}$ is discarded on the $\sigma$-scale and $P:\R\times(0,\infty)\to [0,1]$ is the intensity measurement kernel of scale $\beta$. In \cite{koe.99} they are given by

\begin{equation}
  \begin{split}
    G(\vec{x},\sigma) &= \frac{\exp(-\vec{x}^T\vec{x}/(2\sigma^2))}{(\sqrt{2\pi}\sigma)^{k}}\quad W(\vec{x}_0,\alpha) = \frac{\exp(-(\vec{x}-\vec{x}_0)^T(\vec{x}-\vec{x}_0)/(2\alpha^2))}{(\sqrt{2\pi}\alpha)^{k}},\\
    P(d,\beta) &= \exp(-d^2/(2\beta^2))
  \end{split}\label{loikernel}
\end{equation}

The histogram that can be obtained from this notion is shown in figure \ref{fig:HistSmoothRandIm}.

\begin{figure}
  \centering
  \subfigure{\includegraphics[width=0.4\textwidth]{RandIm.eps}}
  \quad
  \subfigure{\includegraphics[width=0.4\textwidth]{HistRandIm.eps}}
  \caption{Soft isophotes extracted from the smoothened image using the Parzen window in \eqref{loikernel}.}\label{fig:SoftIso}
\end{figure}

Notice that by normalizing $P$, we obtain a Parzen window with infinite support. Let $d=I(\vec{x})-i$, then the values close to $i$ will attain the maximum value of the Parzen window, but any $I(\vec{x})\in \R$ will contribute, since $P(d,\beta)>0$ for all $d\in\R$. Two soft isophotes are extracted from the smoothened noisy image in figure \ref{fig:SoftIso}. The values close to 1 (white) resemble the intensity values close to $i$.\\
The figure \ref{fig:HistRandIm} shows the normal histogram generated as described in section \ref{HistIm} and, for comparison, the smooth histogram using the smooth kernel to extract the isophotes. In the figure \ref{fig:HistSmoothRandIm} the image is smoothened before extracting the isophotes. One might notice that the smooth histogram attains lower values at the extrema of the intensities (0 and 1) in comparison with the traditional histogram. This is caused by the symmetry of the particular Parzen window in \eqref{loikernel}. Since 0 is the minimum there are only larger intensity values in the image, yielding a smaller value in the histogram and correspondingly for 1, the maximum of the intensity values.\\

The Parzen estimate (definition \ref{parzen}) of the probability density can be obtained by normalizing \cite{dar.11}. Hence
\begin{equation}
\bar{p}_I(i,\vec{x}_0,\alpha,\beta,\sigma) = \frac{h_I(i,\vec{x}_0,\alpha,\beta,\sigma)}{\int_\Gamma h_I(k,\vec{x}_0,\alpha,\beta,\sigma)\df k}.
\end{equation}

\begin{figure}
  \centering
  \subfigure[\label{subfig:smoothim}]{\includegraphics[width=0.4\textwidth]{SmoothRandIm.eps}}
  \quad
  \subfigure[\label{subfig:histsmoothim}]{\includegraphics[width=0.4\textwidth]{HistSmoothRandIm.eps}}
  \caption{\ref{subfig:smoothim} Smoothened image and \ref{subfig:histsmoothim} corrensponding histograms using the Gaussian kernel from \eqref{loikernel}.}\label{fig:HistSmoothRandIm}
\end{figure}

Thus from the histogram $h_I$, we can obtain a estimate of the probability density $\bar{p}_I$ on $I$ that varies wrt. $\vec{x}_0$ in local histograms, discarding the local spatial order.\\
Fixing $i,\sigma,\beta$, we obtain a scale space (definition \ref{scalespace}) with the spatial variable $\vec{x}_0$ and scale parameter $\alpha$. Similarly, fixing $\vec{x}_0,\alpha,\sigma$ yields a scale space with $i$ as variable and scale parameter $\beta$. Furthermore the smoothed image $I(\vec{x})*G(\vec{x},\sigma)$ itself is a scale space \cite{dar.12}.\\

 Another popular choice of Parzen windows are B-splines, because they are smooth functions with finite support \cite{the.00}. Note that a B-spline itself is a Parzen window as shown in proposition \ref{PWBspline}. This means that the computation time of the histogram can be reduced significantly, because we are only considering points in the neighborhood in order to compute a certain value of $h$.\\
As mentioned, this formulation also resembles the traditional histogram of an image described in section \ref{HistIm} by letting $\alpha\to\infty$, $\sigma\to 0$ and letting $P=B_m^0$ choosing the knots equidistant with $\Delta i_m = \beta$.